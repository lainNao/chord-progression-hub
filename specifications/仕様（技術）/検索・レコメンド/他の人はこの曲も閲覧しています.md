#

## 方針

- なるべく計算コストを減らしたいので、毎回正規化されたデータを集計するのではなく、集計済みの非正規化されたデータを使いたい

## 詳細

- `非正規化テーブル`（名前的には`chords_other_viewed`等）
  - id ...id
  - music_id ...曲名id
  - other_viewed_music_ids ...他の曲名id配列
  - updated_at ...更新日時
- `更新タイミング`
  - 「他の人はこの曲も閲覧しています」を表示された曲のupdated_atが1日以上前の場合に再集計する
- `集計アルゴリズム`
  - `liked_chords`　・・・ユーザーがいいねをつけたコード進行idテーブル
  - `intentioned_chords`　・・・ユーザーが意識を向けたであろうコード進行idテーブル
    - どのように「意識を向けた」判定するのかは色々あると思うけど、redis使ったりDB使ったりなんだり使うのは今回はなんとなく避ける。
    - シンプルにユーザーの行動を1セッション内でトラッキングし、1セッション内で2回以上その曲の詳細ページにアクセスしたら意識を向けたと判定し、バックエンドにpostする。
  - これのテーブルを使って集計する。流れは以下
    - liked_chordsとintentioned_chordsから、指定の曲IDに紐づいたユーザーを抽出
    - 出したユーザー全員がいいねした曲を集計
