# 結論

`検索用の非正規化したコード進行カラムをいくつか作り、そこに対して全文検索をかける`

## 概説

- そもそも検索なのでSQL又はそれに準ずるものでDBに問い合わせる必要があり、基本的にはあまりコードを介してはならないはずなので、高度な機械学習による類似度判定は使えない
- ベクトルデータにすれば類似度判定がDBに閉じるけれども、そういうのは画像とか曖昧な文章とかに向いてるだけで、コード進行をベクトルデータにしても精度がよくない（いい精度を出すには独自のchord2vecを作る必要があり、面倒。多分無理）。そもそもchord2vecを作るにしても内部実装は重み付けとかで頑張る必要がありそうで、そういう頑張りをするなら結局DBに非正規化した文字列カラムをいくつか作ってそれらから検索しても同じような頑張りなのではと思える

## 詳細

- テーブル構成
  - `chords`テーブル
    - 基本カラム
      - id ...id
      - music_id ...曲名id
      - raw ...一応保存しておく、生のコード進行文字列カラム
  - `chords_for_search`
    - 基本カラム
      - id ...id
      - music_id ...曲名id
      - chords_id ...chordsテーブルのid
    - 以下検索用カラム（meta_infoとかは基本は省略し、全コードを「|」区切りで保存する）
      - normalized ...rawを、#とかbとかをどっちかに統一したカラム
      - tensionless ...normalizedから、テンションコードを抜いたもの
      - functional ...tensionlessを、TSD等の機能に変換したもの。これは転調しようがそのキーの機能でいい。
  - `chords_by_section_for_search`（セクション指定での検索をできるようにするために、セクションごとに行を作るテーブル。。正規表現でどうにかならないか再検討してから決定したいかな）
    - 基本カラム
      - id ...id
      - music_id ...曲名id
      - chords_id ...chordsテーブルのid
      - section_id ...sectionsテーブルのid
    - 以下検索用カラム（meta_infoとかは基本は省略し、全コードを「|」区切りで保存する）
      - normalized ...rawを、#とかbとかをどっちかに統一したカラム
      - tensionless ...normalizedから、テンションコードを抜いたもの
      - functional ...tensionlessを、TSD等の機能に変換したもの。これは転調しようがそのキーの機能でいい。
  - `four_degrees_for_search` ...最大4連続のディグリーから検索するときのテーブル
    - 基本カラム
      - id ...id
      - music_id ...曲名id
      - chords_id ...chordsテーブルのid
    - 以下検索用カラム
      - is_crossing_sections ...セクションをまたいでいるかどうか
      - section_id_start ...始まりのセクションID
      - section_id_end ...終わりのセクションID
      - degrees ...4つ（無いならそれ未満）のディグリーを保存するカラム
        - 留意
          - テンションとかはスルーする。
          - degreeはにおいてはtrgm等を使いやすくするため、全部のディグリーやマイナーメジャー等を1文字のアルファベットで表現したい。かつ#やbは全部bで格納したい。そのため、1はA、1mはa。2bはB、2bmはb。のような規則性とする。
          - 1曲をパースして、このテーブルへの行を複数作る感じ。特にレコードをトリアージしなくていい（個数とかもカウントしたりに使えるかもなので）
- `pg_trgm`を使う等する

    ```sql
    CREATE EXTENSION pg_trgm;
    CREATE INDEX idx_column_trgm ON your_table USING gin(column_name gin_trgm_ops);
    ```

## 懸念事項

- 2222555511116666 みたいな長いコード進行も「2516」で検索引っかかるようにしたい。
  - かといって4444444411116666のDBに入れるデータを「416」とかにしたら「1416」と検索しても引っかかっちゃうからそういうのは嫌だなどうすればいいか
  な
  - `結論:` いやこういうのはそもそも2516で登録すればいいのでは？
