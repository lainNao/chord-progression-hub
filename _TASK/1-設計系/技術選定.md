# 技術選定

> 固定ではなく、多少変わるかもしれない。あくまでも現状の決定

- [未検討項目](#未検討項目)
- プロジェクト管理
  - [ ] [仕様からタスクとTODOを自動生成](https://zenn.dev/kyln/scraps/cb3007de4fb018)
- インフラ
  - [ ] `Git`　・・・GitHub
  - [ ] `CI`　・・・GitHub Actions、Lefthook
  - [ ] `CD`　・・・GitHub Actions、etc
  - [ ] `IaC`　・・・Terraform
  - [ ] `CDN`　・・・Cloudflare
  - [ ] `ドメイン取得`　・・・？
  - [ ] `DNS`　・・・Cloudflare
  - [ ] `ロードバランサー`　・・・?
  - [ ] `ホスティング`　・・・Cloudflare workers
    - Next.js on Cloud Runにするつもりだったけど、Remixにしたのでworkersで
  - [ ] `メール`　・・・？
  - [ ] `ログ`　・・・？
  - [ ] `モニタリング`　・・・？
  - [ ] `バックアップ`　・・・？
  - [ ] `メッセージング`　・・・？
  - [ ] `バッチ・ジョブ`　・・・？
  - [ ] `アクセス解析`　・・・Google Analytics？
  - [ ] `環境分離（本番、ステージング、開発）`　・・・Gitのブランチでdevelop、staging、productionを分ける（mainは不要）。stagingにプッシュされたらステージング環境にデプロイし、productionにプッシュされたら本番環境にデプロイする。でいいかな？
- データ
  - [ ] `DB`　・・・PlanetScale
    - 安牌っぽい。ChatGPTに見積もってもらったらCloudSQLよりも結構安かった
    - Neon　・・・トランザクションがwebsocketで面倒かも？
    - D1　・・・maximum database sizeが2GBと小さい
    - Turso　・・・sqliteなので特大データで怖いかも。fts5は使いたかったけど、
      - docker使わないでローカル開発できるかもなのは偉くはある
    - PlanetScale　・・・
      - FULLTEXT タイプのインデックス貼ればngramできるっぽいしOK？うーんでもngramでよいものか…
        - これが試して微妙だったらTursoでfts5（tokenize=ascii）を使うかも。試してみてから決めたい
      - コレーションに注意
      - 外部キーは今ベータで対応してるっぽい
    - Digital Ocean　・・・VPS感
    - ScaleGrid　・・・どうなんだろう？
    - HarperDB　・・・どうなんだろう？
  - [ ] `DB管理`　・・・bytebase？
    - 面白そうなので。どうだろう？
  - [ ] `ストレージ`　・・・Cloudflare R2
  - [ ] `セッション`　・・・Cloudflare KV? Upstash？
  - [ ] `フォント`　・・・Cloudflare Fonts
- アプリケーション
  - [ ] `サーバー`　・・・Remix
    - Next.js　・・・
      - キャッシュ機構、next/imageなど、Vercel使わないと少し面倒？
      - VercelはAWSに乗ってるので、それならAWS使いたい（というか高いイメージ）
    - Remix　・・・
      - Cloudflare使うならRemixが良さそう。
        - 注意点としてworkersは1MBのリミットがあるっぽいのであまりバンドルサイズの大きいライブラリを使ってはいけない（間に合うのかな、）
        - 有料なら10MB
        - 小さくするのはCIとしてもコスパいいので、やってみたくはある
      - Next.jsはある程度使ったことある
      - ただ、Cloudflare workersをサイズなどの制限で使えないとなった場合、Next.jsにするはず
    - Qwik city　・・・
      - 安さを追求するならこういうパフォーマンスを意識したやつでもありではあるのかも知らんけど
  - [ ] `ORM`　・・・Prisma、駄目ならDrizzle、駄目ならKysely
  - [ ] `APIクライアント`　・・・不要？またはtRPC等
    - （Next.jsのappルーターだとたぶんRESTは出る幕無いので、たぶん簡単なやつでいい）
  - [ ] `課金`　・・・？
  - [ ] `ログイン`　・・・？（Clerk？next/auth？）
  - [ ] `メール送信`　・・・AWS SES
    - 安いらしいので <https://zenn.dev/link/comments/fbe8e9be92ac10>
    - Resend　・・・SESに負けるっぽい？
    - SendGrid　・・・SESに負けるっぽい？
  - [ ] `メール本文作成`　・・・react email（emailのhtmlをreactコンポーネントで作れるやつ）
  - [ ] `コンポーネントライブラリ`　・・・chadcn/ui、tailwind
  - [ ] `i18n`　・・・？
    - なんか色々試されていた <https://twitter.com/d151005/status/1727190995299881006>
    - トップページだけはやっぱりSEO的な意味でサブパスでのルーティングにして国ごとに分けていいのかも…？
    - 全部サブドメインルーティングにするのはしなくていい気がする（手軽ならやっちゃっていいかもだけど）
  - [ ] `フォーム`　・・・？（Tally？）
    - できればreact-hook-formとかは面倒なので使いたくない。やってみて駄目なら使う
- テスト
  - [ ] `VRT`　・・・Chromatic（ただし料金的な意味で、導入はデグレを防ぎたくなってきた時期（完成が見えてから）でいい）
    - もしR2でreg-suit使えるならreg-suitでもいいかも
  - [ ] `E2E`　・・・Playwright
  - [ ] `テストランナー` ・・・jest
  - [ ] `リント`　・・・ESLint、Prettier、ls-lint、stylelint、etc
- ユーティリティ
  - [ ] `Next.jsのルート可視化`　・・・NEXT.NAV

## 参考

- <https://zenn.dev/mizchi/articles/fullstack-remix-d1-boilerplate>
- <https://note.com/jnlmyz/n/n51dd526fbac0>
- <https://zenn.dev/lovegraph/articles/56f8d5f28ba1c3>
- <https://twitter.com/yusukebe/status/1716768420216332624>
  - 安い
- <https://laiso.hatenablog.com/entry/2023/11/23/210736>
- GCPはlocalstack的なエミュレータが公式であるらしい
  <https://www.reddit.com/r/googlecloud/comments/h82qyi/is_there_anything_like_localstack_for_gcp/>
- <https://zenn.dev/catnose99/articles/f8a90a1616dfb3>
- <https://planetscale.com/lp/lower-gcp-bill>を見るとDBはGoogle Cloud Databaseを使うよりPlanetScaleの方が安いっぽい。公式が書いてるので…
ただ、読み込み行数が料金に大きな影響を与えると<https://zenn.dev/catnose99/articles/f8a90a1616dfb3>で言われてるので、場合によっては本当にインデックスの工夫というよりもむしろ検索系機能はキーバリュー系のDBにしたほうが安くなる可能性すらある
- <https://zenn.dev/ring_belle/books/athenai-develop/viewer/gcp-project-terraform>
- <https://zenn.dev/catnose99/articles/f99ea2a8b985b2>
- <https://zenn.dev/team_zenn/articles/nextjs-standalone-mode-cloudrun#%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E3%82%A2%E3%83%AD%E3%83%B3%E3%83%A2%E3%83%BC%E3%83%89%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%A8%E6%AF%94%E8%BC%83>
- <https://zenn.dev/shoito/articles/nextjs-on-google-appengine>
- ライブラリのバージョンをrenovateとかdepenadabotとかで上げるの、メジャーバージョンアップ追従or脆弱性対応or「この機能が必要だから今すぐ上げたい」の3種類だけでいいのでは感が出てきた。細かく上げていたらCI代がかかりそう
- PgBouncer等のコネクションプール
- VRT、こういうのが安くてクロスブラウザでよさそうかもね <https://speakerdeck.com/kubotak/storybookwoshu-kudakederiguretusiyontesutoga-shi-xing-sarerushi-jie-heyoukoso?slide=57>
  - S3でVRTして料金あんまかけたくないな…
- playwrightのUIモード？でやればstorybookいらないのでは
  - playwrightのVRTは直接リポジトリ内に画像を保存するのが基本かもだけど、S3に置くやり方もあるし、ただS3に置くのが嫌ならもうリポジトリ内に置いちゃって、リポジトリにコミットしちゃうのもありだと思う。そのリポジトリを別リポジトリにして、仮にgit的に重くなってきたらまた新規でリポジトリを作り直すとかすれば。
    - または特定ディレクトリ以下のgit履歴を完全破棄するみたいなことができれば、スクショを入れておくフォルダを定期的にそうやってリセットするとか（できるならば）

## 未検討項目

- 必要なインフラ構成
- ブルーグリーンデプロイとかの安全なデプロイをどうやるか
