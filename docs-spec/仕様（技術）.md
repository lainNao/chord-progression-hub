# 目次

- [技術選定]
  - [セキュリティ技術](#セキュリティ技術)
  - [インフラ技術](#インフラ技術)
  - [バックエンド技術](#バックエンド技術)
  - [DB技術](#db技術)
  - [フロントエンド技術](#フロントエンド技術)
  - [テスト技術](#テスト技術)
  - [監視技術](#監視技術)

## DB技術

- `テーブル定義`
  - [ ] `DBのエンティティ`フォルダにあるエンティティがテーブルのイメージで、それをを元にテーブルを作成(spec-20231221010009)
- `パフォーマンス`
  - [ ] 10万件でのlike検索が1秒台で結果返ってきたので、もうとりあえずしばらくはlike検索でいいはず(spec-20231221010205)
  - [ ] 仮にlike検索ではどうともならなくなってきた時、コストかけてどうにか考える(spec-20231221010207)
- `検討したこと`
  - パフォーマンス周り
    - fts5　・・・うまくtokenizeしてくれなくて面倒だった。そもそも普通のlike検索がそれなりに早かったから一旦いいやとなった
    - pg_trgm　・・・trigramが合わないと思う
    - elasticsearch　・・・言うほど早くなかったのと、_analyzeした時に勝手に小文字化されて面倒だった。そもそも普通のlike検索がそれなりに早かったから一旦いいやとなった
  - 検索用の非正規化したデータを格納するテーブルをいくつか作り、そこに対して全文検索をかけるようにする →採用
  - ベクトル検索
    - そもそも検索なのでSQL又はそれに準ずるものでDBに問い合わせる必要があり、基本的にはあまりコードを介してはならないはずなので、高度な機械学習による類似度判定は使えない
      - ベクトルデータにすれば類似度判定がDBに閉じるけれども、そういうのは画像とか曖昧な文章とかに向いてるだけで、コード進行をベクトルデータにしても精度がよくない（いい精度を出すには独自のchord2vecを作る必要があり、面倒。多分無理）。そもそもchord2vecを作るにしても内部実装は重み付けとかで頑張る必要がありそうで、そういう頑張りをするなら結局DBに非正規化した文字列カラムをいくつか作ってそれらから検索しても同じような頑張りなのではと思える
  - `2222555511116666 みたいな長いコード進行も「2516」で検索引っかかるようにしたい件`
    - かといって4444444411116666のDBに入れるデータを「416」とかにしたら「1416」と検索しても引っかかっちゃうからそういうのは嫌だなどうすればいいか
    な
    - `結論:` いやこういうのはそもそも2516で登録すればいいのでは？
  - Q: 検索系テーブル、ハッシュテーブル的なNoSQLでは駄目なの？
    - A: 要件的に無理っぽい。工夫すればできるのかな…？

## 監視技術

- [ ] エラーは収集する(spec-20231221011017)
  - [ ] 特に例えばchord-progression-ast-parser関連のエラーは、エラーとなった入力ももらってくる(spec-20231221011038)
    - 単なる「正常なバリデーションエラー」の場合は収集は不要

## フロントエンド技術

- [ ] カラーパレットはツールを使う(spec-20231221020049)
  - `候補`
    - <https://github.com/material-foundation/material-color-utilities>
- [ ] `コンポーネントライブラリ`　・・・chadcn/ui、tailwind(spec-20231220223357)
  - chadcn/uiにした理由
    - 大量テーマ切り替えが楽そう <https://ui.shadcn.com/themes>
    - フォームが多くならないはず
      - 仮にフォームが多くなる場合、フォーム系コンポーネントにはshadcn/uiだともしかしたら面倒になりそう
- [ ] `フォーム`　・・・？（Tally？）(spec-20231220223402)
  - できればreact-hook-formとかは面倒なので使いたくない。やってみて駄目なら使う
- [ ] `APIクライアント`　・・・不要？またはtRPC等(spec-20231220223340)
  - （Next.jsのappルーターだとたぶんRESTは出る幕無いので、たぶん簡単なやつでいい）
- [ ] `可変サイズ`　・・・htmlタグにfont-sizeを設定し、配下では絶対にrem指定をすることで対応。font-sizeだけど、これはrem全体に聞くはずなので、画像サイズとかにも有効にできるはず。ちなみにQaseはそんな感じで実装してるはず(spec-20231221004035)
- [ ] browserslist等工夫して、古いCSS対応も自動化したい(spec-20231221010458)
  - post cssとかも
  - できれば自動チェック

## テスト技術

- [ ] `packages-dev/commonTestCaseRunners`を使い、汎用的なテストケースを網羅させる。仕様として管理するまでもないが地味に重要なやつを逃さないようにしたい。(spec-20231221015337)
- [ ] `VRT`　・・・Chromatic（ただし料金的な意味で、導入はデグレを防ぎたくなってきた時期（完成が見えてから）でいい）(spec-20231220223404)
  - もしR2でreg-suit使えるならreg-suitでもいいかも
- [ ] `E2E`　・・・Playwright(spec-20231220223405)
  - axe-playwright
- [ ] `テストランナー` ・・・jest、storybook(spec-20231220223407)
  - @storybook/addon-interactions
- [ ] `リント`　・・・ESLint、Prettier、ls-lint、stylelint、etc(spec-20231220223408)
  - eslint-plugin-unicorn
  - eslint-plugin-react
  - eslint-plugin-react-hooks
  - eslint-plugin-jsx-a11y
  - eslint-plugin-import
  - eslint-plugin-storybook
  - eslint-plugin-jest
  - eslint-plugin-testing-library
  - typescript-eslint
  - @storybook/addon-a11y
- ユーティリティ
  - `typescript-eslint`がeslintはフラットコンフィグをサポートしないとか言ってるらしいので注意しておく
  - [ ] `~.◯◯.ts`などの〇〇の部分に入るやつはls-lintとかでリントかけよう。sつけ忘れや逆にsが多くなるとかで統制取れなくなるから(spec-20231221004150)
- [ ] `Next.jsのルート可視化`　・・・NEXT.NAV(spec-20231220223411)
- [ ] `バンドルサイズ監視`　・・・?(spec-20231221004100)

## バックエンド技術

- [ ] `サーバー`　・・・Remix(spec-20231220223334)
  - Next.js　・・・
    - キャッシュ機構、next/imageなど、Vercel使わないと少し面倒？
    - VercelはAWSに乗ってるので、それならAWS使いたい（というか高いイメージ）
  - Remix　・・・
    - Cloudflare使うならRemixが良さそう。
      - 注意点としてworkersは1MBのリミットがあるっぽいのであまりバンドルサイズの大きいライブラリを使ってはいけない（間に合うのかな、）
      - 有料なら10MB
      - 小さくするのはCIとしてもコスパいいので、やってみたくはある
    - Next.jsはある程度使ったことある
    - ただ、Cloudflare workersをサイズなどの制限で使えないとなった場合、Next.jsにするはず
  - Qwik city　・・・
    - 安さを追求するならこういうパフォーマンスを意識したやつでもありではあるのかも知らんけど
- [ ] `ORM`　・・・Prisma、駄目ならDrizzle、駄目ならKysely(spec-20231220223338)
- [ ] `課金`　・・・？(spec-20231220223347)
- [ ] `ログイン`　・・・？（Clerk？next/auth？）(spec-20231220223350)
- [ ] `メール送信`　・・・AWS SES(spec-20231220223352)
  - 安いらしいので <https://zenn.dev/link/comments/fbe8e9be92ac10>
  - Resend　・・・SESに負けるっぽい？
  - SendGrid　・・・SESに負けるっぽい？
- [ ] `メール本文作成`　・・・react email（emailのhtmlをreactコンポーネントで作れるやつ）(spec-20231220223354)
- [ ] `i18n`　・・・？(spec-20231220223359)
  - なんか色々試されていた <https://twitter.com/d151005/status/1727190995299881006>
  - トップページだけはやっぱりSEO的な意味でサブパスでのルーティングにして国ごとに分けていいのかも…？
  - 全部サブドメインルーティングにするのはしなくていい気がする（手軽ならやっちゃっていいかもだけど）

## セキュリティ技術

- [ ] `DDoS対策`　・・・?(spec-20231220223430)
  - MPAなので、実質これがSPAのレートリミット対策と同じことになるはず。
  - なのでほぼレートリミット対策は不要。API作るならこういうので考える <https://zenn.dev/catnose99/articles/9183c86d3558e5>

## インフラ技術

- [ ] GCPの環境は新規でプロジェクト用のメールアドレスを作成し、それから構築する(spec-20231221014424)
  - そちらのほうが業務的な活動メールアドレスであるし、かつ無料枠が使えるかもなので。
- [ ] `ブルーグリーンデプロイとかの安全なデプロイをどうやるか`(spec-20231220223912)
- [ ] `Git`　・・・GitHub(spec-20231220223235)
- [ ] `CI`　・・・GitHub Actions、Lefthook(spec-20231220223236)
- [ ] `CD`　・・・GitHub Actions、etc(spec-20231220223238)
- [ ] `IaC`　・・・Terraform(spec-20231220223239)
- [ ] `CDN`　・・・Cloudflare(spec-20231220223240)
- [ ] `ドメイン取得`　・・・？(spec-20231220223242)
- [ ] `DNS`　・・・Cloudflare(spec-20231220223243)
- [ ] `ロードバランサー`　・・・?(spec-20231220223244)
- [ ] `ホスティング`　・・・Cloudflare workers(spec-20231220223245)
  - Next.js on Cloud Runにするつもりだったけど、Remixにしたのでworkersで
- [ ] `メール`　・・・？(spec-20231220223250)
- [ ] `ログ`　・・・？(spec-20231220223252)
- [ ] `モニタリング`　・・・？(spec-20231220223253)
- [ ] `バックアップ`　・・・？(spec-20231220223255)
- [ ] `メッセージング`　・・・？(spec-20231220223256)
- [ ] `バッチ・ジョブ`　・・・？(spec-20231220223300)
- [ ] `アクセス解析`　・・・Google Analytics？(spec-20231220223304)
- [ ] `環境分離（本番、ステージング、開発）`　・・・Gitのブランチでdevelop、staging、productionを分ける（mainは不要）。stagingにプッシュされたらステージング環境にデプロイし、productionにプッシュされたら本番環境にデプロイする。でいいかな？(spec-20231220223306)
- データ
- [ ] `DB`　・・・PlanetScale(spec-20231220223309)
  - 安牌っぽい。ChatGPTに見積もってもらったらCloudSQLよりも結構安かった
    - でもTursoと分担してもよいのかも
  - Neon　・・・トランザクションがwebsocketで面倒かも？
  - D1　・・・maximum database sizeが2GBと小さい
  - Turso　・・・sqliteなので特大データで怖いかも。fts5は使いたかったけど、
    - docker使わないでローカル開発できるかもなのは偉くはある
  - PlanetScale　・・・
    - FULLTEXT タイプのインデックス貼ればngramできるっぽいしOK？うーんでもngramでよいものか…
      - これが試して微妙だったらTursoでfts5（tokenize=ascii）を使うかも。試してみてから決めたい
    - コレーションに注意
    - 外部キーは今ベータで対応してるっぽい
  - Digital Ocean　・・・VPS感
  - ScaleGrid　・・・どうなんだろう？
  - HarperDB　・・・どうなんだろう？
- [ ] `DB管理`　・・・bytebase？(spec-20231220223328)
  - 面白そうなので。どうだろう？
- [ ] `ストレージ`　・・・Cloudflare R2(spec-20231220223330)
- [ ] `セッション`　・・・Cloudflare KV? Upstash？(spec-20231220223331)
- [ ] `フォント`　・・・Cloudflare Fonts(spec-20231220223332)
